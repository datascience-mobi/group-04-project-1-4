---
title: "Linear regression"
author: "Elias Benjamin Farr"
date: "17 Mai 2019"
output:
  word_document: default
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Multilinear Regression
## Objective

  + For the regression model, we want to predict the CERES score of the driver mutation (dependent variable) based on the CERES score of the SST candidates (independent variables).
  + A multilinear regression will be designed:
  
--------------------------------------------------------------------------------------------

#### Elias Idea (keep)
```{r}
SSTs <- c(rownames(finalFrame)) #could be any list of SSTs
LinResdf0 <- BCCL_kd.ceres[SSTs,] #df, consisting 28 col, nSTTs rows
# something like that: drivmutCL <- c(BCCL_Mutation["Hugosymbol"" == "ERBB2" ])
LinResdf1 <- subset(LinResdf0, colname == drivmutCL)


```
### Lisas Idea (keep)
## Step 1: Building the LR-Datamatrices
#Generate matrices containing CERES scores of DV and corresponding SSTs

+ We now obtained potential SSTs for the four driver mutation. To form a base for the Multilinear regression, we 
    1. reform the BCCL CERES matrix
      + By transponing and format change, we obtain a matrix with colnames = Gene names and rownames = Cell line indices (equal to tPatients_ID)
    2. Collect the relevant the CERES scores for the mutations for the linear regression.
      + All columns with the corresponding names of the driver mutation plus SST genes will be collected and copied into a new dataframe
```{r}
#reformat BCCL CERES matrix
BCCL_kd.ceres_df <- as.data.frame(t(BCCL_kd.ceres))
rownames(BCCL_kd.ceres_df) <- tPatients_ID
colnames(BCCL_kd.ceres_df) <- rownames(BCCL_kd.ceres)

#generate a dataframe containing data for each DV
linRegData_ERBB2 <- BCCL_kd.ceres_df %>% select("ERBB2", rownames(SST_cand_ERBB2))
linRegData_MYCBP <- BCCL_kd.ceres_df %>% select("MYCBP", rownames(SST_cand_MYCBP))
linRegData_PARP10 <- BCCL_kd.ceres_df %>% select("PARP10", rownames(SST_cand_PARP10))
linRegData_PIK3CA <- BCCL_kd.ceres_df %>% select("PIK3CA", rownames(SST_cand_PIK3CA))
```
---------------------------------------------------------------------------------------------
# Step 1: Load data
  1. Save driver mutation names in column
  2. COllect CERES scores of SSTs per driver mutation in data frame list
  
```{r}
driver_mut <- c("ERBB2","MYCBP", "PARP10", "PIK3CA") #Input driver mutations

data_ls <- list(SST_cand_ERBB2, SST_cand_MYCBP, SST_cand_PARP10, SST_cand_PIK3CA)
names_ls <- c("ERBB2", "MYCCBP", "PARP10", "PIK3CA")
```

# Step 2: Construct datasets for Regression
  + Returns dataframe list will SST names as columns and cell lines as rows, data consisting of CERES scores
```{r}
mlr <- function(input_data, names, muts) {
  output <- lapply(seq_along(input_data), function(x){
    candidatas <- c(rownames(input_data[[x]]))
    dataPicker <- t(BCCL_kd.ceres[candidatas,])
    driverPicker <- t(BCCL_kd.ceres[muts[x], ])
    outData <- as.data.frame(cbind(dataPicker, driverPicker))
    return(outData)
  })
  names(output) <- names
  return(output)
}

test <- mlr(data_ls, names_ls, driver_mut)
lapply(test, head)
```

#Step 3: qqplot
  + Check Normality with a qqPlot
```{r}
lapply(seq_along(test), function(x) ggplot(test[[x]], aes(sample=test[[x]][,ncol(test[[x]])]))+stat_qq()) #aes: aesthetic mapping
#why only one (confusion)
```

#Step 4: 
To run the Multilinear Regression, it is advised to create a long function which
  1. Splits the dataset in 75:25 training:test data
    + Previous installation of the "caTools" package is necessary
  2. Conducts Training of Regression model with training data
    + predict Driver mutation CERES (y; dep.variable) from SST CERES scores (x1 ... xn; indep.variables)
  3. Runs Test Data on model for performance evaluation
  4. Calculates Spearman correlation to further asess model performance
```{r}
input_data <- test
lapply(seq_along(input_data), function(x) {
  set.seed(123) #initialize the random numbers #WHY
  data <- input_data[[x]] #get the data
  colnames(data)[length(colnames(data))] <- "Predictor"
  
  split = sample.split(data[,ncol(data)], SplitRatio = 0.75) #split the dataset into 3/4 Training and 1/4 Testing dataset
  training_set = subset(data, split == TRUE) #use the labels to get the training data
  test_set = subset(data, split == FALSE)

  regressor = lm(formula = Predictor ~ ., 
                 data = training_set)  #predict CERES of Driver Mutation based on all (=.) the input variables (SSTs)
  
  y_pred = predict(regressor, newdata = test_set) #predict the Driver mut. CERES score based on the test data
  test_set$Prediction = y_pred #adding predictions to the dataset
  corVal <- cor.test(test_set$Predictor , test_set$Prediction, method = "spearman")#to judge model performance, calculate Spearman corr. between predicted and observed values
  return(corVal)
})
```

--------------------------------------------------------------------------------------------
## Step 3: Multilinear Regression: Data Preperation, Model Training /Testing / Evaluation
To run the Multilinear Regression, it is advised to create a long function which
  1. Splits the dataset in 75:25 training:test data
    + Previous installation of the "caTools" package is necessary
  2. Conducts Training of Regression model with training data
    + predict Driver mutation CERES (y; dep.variable) from SST CERES scores (x1 ... xn; indep.variables)
  3. Runs Test Data on model for performance evaluation
  4. Calculates Spearman correlation to further asess model performance
    + Visualizes by barplot
```{r}
install.packages("caTools")
library(caTools) #necessary packages

MultiLinReg <- function(x){
                          DependentVariable <- colnames(x[1]) #The dependent variable is always the driver mutation
                          split = sample.split(x["DependentVariable"], SplitRatio = 0.75) #split the dataset into 3/4 Training and 1/4 Testing dataset
                          training_set = subset(x, split == TRUE)
                          test_set = subset(x, split == FALSE)
                          
                          regressor = lm(formula = DependentVariable ~ ., data=training_set)
                          #predict CERES of Driver Mutation based on all (=.) the input variables (SSTs)
                          
                          y_predict = predict(regressor, newdata = test_set) #predict the Driver mut. CERES score based on the test data
                          test_set$Prediction = y_predict #adding predictions to the dataset
                          test_set #Now you can compare your Predictions (last column) with the real values of the startups (2nd last column)
                          
                          cordf <- cor.test(test_set$DependentVariable, test_set$Prediction, method = spearman) #to judge model performance, calculate Spearman corr. between predicted and observed values
                          barplot(cordf, main = deparse(substitute(x))) #create a barplot for correlation visualization and further evaluation
}

df.list.MLR <- list(linRegData_ERBB2, linRegData_MYCBP, linRegData_PARP10, linRegData_PIK3CA)
lapply(df.list.MLR, MultiLinReg)

# CURRENT ISSUE: "Error in terms.formula(formula, data = data) : '.' erscheint in der Formel und 'data' Argument ist ung?ltig"
```

----------------  
## Ideas collected from:
[linked phrase](https://www.dataquest.io/blog/statistical-learning-for-predictive-modeling-r/)
[linked phrase](http://r-statistics.co/Linear-Regression.html#Predicting%20Linear%20Models)
